#!/bin/bash

TERMUX_UTILS=$(realpath $(dirname ${BASH_SOURCE}))


export USER_SCRIPTS=$HOME/.local/bin
export PATH=$USER_SCRIPTS:$PATH


# These will affect the loading of some things.
if ! [[ -f "$HOME/.termux_env_tweaks" ]];
then
    touch "$HOME/.termux_env_tweaks"
fi

source "$HOME/.termux_env_tweaks"

echo "Loaded tweaks for Termux environment, if any."
echo ""


ps -e | grep -q " sshd"

if [[ "$?" == "0" ]]
then
    echo -e "Enabling SSH server..."

    sv-enable sshd

    if [[ "$?" == "0" ]];
    then
        echo -e "Done\n"
    else
        echo -e "Failed. Packages openssh and/or termux-services"
        echo -e "may be missing.\n"
    fi
fi


if [[ -v ENABLE_PROOTS ]];
then
    if ! [[ -f "$PREFIX/bin/proot-distro" ]];
    then
        echo ""
        echo -e "Proots support is enabled, but proot-distro is missing."
        echo -e "Please, install it first\n."
    else
        source "$TERMUX_UTILS/proots/.proots_env"
    fi
fi


if [[ -v ENABLE_X11 ]];
then
    if ! [[ -f "$PREFIX/bin/termux-x11" ]];
    then
        echo ""
        echo -e "X11 support is enabled, but termux-x11 is missing."
        echo -e "Please, run x11/for_termux/setup.sh.\n"
    else
        source "$TERMUX_UTILS/x11/.x11_env"
    fi
fi


if [[ -v ENABLE_AUDIO ]];
then
    if ! [[ -f "$PREFIX/bin/pulseaudio" ]];
    then
        echo ""
        echo -e "Audio support is enabled, but pulseaudio is missing."
        echo -e "Please, install it first.\n"
    else
        source "$TERMUX_UTILS/x11/.audio_env"
    fi
fi


if [[ -v ENABLE_MIDI ]];
then
    if ! [[ -f "$PREFIX/bin/fluidsynth" ]];
    then
        echo ""
        echo -e "MIDI support is enabled, but fluidsynth is missing."
        echo -e "Please, install it first.\n"
    else
        source "$TERMUX_UTILS/x11/midi_support/.midi_env"
    fi
fi


if [[ -v ENABLE_3D ]];
then
    if ! [[ -f "$PREFIX/bin/virgl_test_server_android" ]];
    then
        echo ""
        echo -e "3D support is enabled, but virgl is missing."
        echo -e "Please, install it first.\n"
    else
        source "$TERMUX_UTILS/x11/.3d_env"
    fi
fi


# Your own config
if [[ -f "$HOME/.user_env" ]] && ! [[ -v DISABLE_USER_ENV ]];
then
    source "$HOME/.user_env"

    echo "Loaded user environment."
    echo ""
fi


echo "Finished loading Termux environment."
echo ""
echo "If want to enable a functionality at startup, add one of more of"
echo "these to the ~/.termux_env_tweaks file."
echo ""
echo "- export ENABLE_PROOTS=1"
echo "- export ENABLE_X11=1"
echo "- export ENABLE_MIDI=1"
echo "- export ENABLE_3D=1"
echo ""
echo "If you have been told to install something for a module, all paths"
echo "are relative to $TERMUX_UTILS."
echo ""
